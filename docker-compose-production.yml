services:
  workshop_db:
    container_name: workshop-db
    build:
      context: .
      dockerfile: Dockerfile.pgbackrest
    image: workshop/postgres16-pgbackrest:latest
    restart: always
    environment:
      LC_ALL: C.UTF-8
      TZ: America/Sao_Paulo
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "${HOST_BIND_IP}:5432:5432"
    command:
      - "-c"
      - "listen_addresses=*"
      - "-c"
      - "wal_level=replica"
      - "-c"
      - "archive_mode=on"
      - "-c"
      - "archive_timeout=60s"
      - "-c"
      - "archive_command=pgbackrest --stanza=workshop archive-push %p"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB && psql -U $$POSTGRES_USER -d $$POSTGRES_DB -c 'SELECT 1' > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    volumes:
      - db_data:/var/lib/postgresql/data
      - /srv/pgbackrest/conf:/etc/pgbackrest
      - /srv/pgbackrest/repo:/var/lib/pgbackrest
      - /srv/pgbackrest/logs:/var/log/pgbackrest
      - /srv/postgres/logical_dumps:/backups/logical
    networks:
      - workshop-network

  workshop_spring_app:
    container_name: workshop-api
    restart: always
    build: .
    image: workshop_rest_api-workshop_spring_app:latest
    ports:
      - "8080:8080"
    depends_on:
      workshop_db:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://workshop_db:5432/${DB_NAME}
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      SPRING_PROFILES_ACTIVE: production
      JAVA_TOOL_OPTIONS: "-Xms256m -Xmx768m"
      TZ: America/Sao_Paulo
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health || curl -fsS http://localhost:8080/actuator/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    networks:
      - workshop-network

  # ===========================================
  # OBSERVABILIDADE
  # ===========================================
  
  loki:
    image: grafana/loki:2.9.2
    container_name: loki
    ports:
      - "127.0.0.1:3100:3100"  # Apenas localhost
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./infra/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    networks:
      - workshop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  promtail:
    image: grafana/promtail:2.9.2
    container_name: promtail
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./infra/promtail-config.yaml:/etc/promtail/config.yaml:ro
    command: -config.file=/etc/promtail/config.yaml
    depends_on:
      - loki
    networks:
      - workshop-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana
    ports:
      - "127.0.0.1:3000:3000"  # Apenas localhost (acesso via SSH tunnel)
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s:%(http_port)s/
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - loki
    networks:
      - workshop-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  db_data:
  loki_data:
  grafana_data:

networks:
  workshop-network:
